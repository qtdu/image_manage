<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Google Sheet CRUD + ImgBB</title>

<style>
*{
  box-sizing:border-box;
}

body{
  font-family:sans-serif;
  max-width:1100px;
  margin:auto;
  padding:12px;
}

/* ===== TI√äU ƒê·ªÄ + N√öT TH√äM ===== */
.header-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

/* ===== INPUT / BUTTON ===== */
input, button{
  padding:8px;
  font-size:14px;
}

button{
  cursor:pointer;
  white-space:nowrap;
}

/* ===== UPLOAD ROW ===== */
.upload-row{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:nowrap;           /* ‚ùó KH√îNG XU·ªêNG D√íNG */
}

/* file input chi·∫øm ph·∫ßn c√≤n l·∫°i */
.upload-row input[type="file"]{
  flex:1;
  min-width:0;               /* ‚ùó fix tr√†n mobile */
}

/* ===== PREVIEW ·∫¢NH NH·ªé ===== */
img.preview{
  width:60px;
  height:60px;
  object-fit:cover;
  border:1px solid #ccc;
  display:none;
  flex-shrink:0;             /* ‚ùó kh√¥ng b·ªã √©p nh·ªè */
}

/* ===== FORM INPUT ===== */
.form-row{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:8px;
  margin-top:8px;
}

/* ===== TABLE ===== */
.table-wrap{
  overflow-x:auto;
}

table{
  width:100%;
  border-collapse:collapse;
  min-width:650px;
}

th, td{
  border:1px solid #ccc;
  padding:6px;
  text-align:left;
  vertical-align:top;
}

td[contenteditable]{
  background:#f9f9f9;
}

td:focus{
  outline:2px solid #4caf50;
}

img.thumb{
  max-width:100px;
  display:block;
}

/* ================= MOBILE ================= */
@media(max-width:768px){

  .header-row{
    flex-direction:row;
  }

  .form-row{
    grid-template-columns:1fr;
  }

  table{
    font-size:13px;
  }

  img.thumb{
    max-width:80px;
  }
}

/* ===== MOBILE NH·ªé (ƒêI·ªÜN THO·∫†I) ===== */
@media(max-width:480px){

  button{
    padding:6px 8px;
    font-size:13px;
  }

  img.preview{
    width:44px;
    height:44px;
  }
}

</style>
</head>

<body>

<!-- ================= UPLOAD ================= -->
<h3>üì§ Upload ·∫£nh</h3>

<div class="upload-row">
  <input type="file" id="imageInput" accept="image/*" onchange="previewLocal(this)">
  <button onclick="uploadImage()">Upload ·∫£nh</button>
  <img id="preview" class="preview">
</div>

<div id="status"></div>

<hr>

<!-- ================= ADD ================= -->
<div class="header-row">
  <h3>‚ûï Th√™m d·ªØ li·ªáu</h3>
  <button onclick="add()">Th√™m</button>
</div>

<!-- Link ·∫£nh ·∫®N -->
<input id="link" type="hidden">

<div class="form-row">
  <input id="name1" placeholder="Name">
  <input id="note" placeholder="Note">
</div>

<hr>

<!-- ================= TABLE ================= -->
<h3>üìã Danh s√°ch</h3>
<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Time</th>
  <th>·∫¢nh</th>
  <th>Name</th>
  <th>Note</th>
  <th>X</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

<script>
/* ================= CONFIG ================= */
const SHEET_API = "https://script.google.com/macros/s/AKfycbymlIeO7SqDLqE_3HHGbhYyPlKiT1mlBSR58njBzUWHUGAbOQYdMnSvX7CeL0OkX48/exec";
const IMGBB_KEY = "98bce19081883f35f02cec232ce565b5";

/* ================= LOCAL PREVIEW ================= */
function previewLocal(input){
  const file = input.files[0];
  if(!file) return;

  const img = document.getElementById("preview");
  img.src = URL.createObjectURL(file);
  img.style.display = "block";
}

/* ================= LOAD DATA ================= */
function load(){
  fetch(SHEET_API)
    .then(r=>r.json())
    .then(data=>{
      const tb = document.getElementById("list");
      tb.innerHTML = "";

      data.reverse().forEach(d=>{
        tb.innerHTML += `
        <tr>
          <td>${d.time}</td>
          <td>
            <a href="${d.link}" target="_blank">
              <img class="thumb" src="${d.link}">
            </a>
          </td>
          <td contenteditable
              onkeydown="save(event,${d.row},3,this)">
              ${d.name}
          </td>
          <td contenteditable
              onkeydown="save(event,${d.row},4,this)">
              ${d.note}
          </td>
          <td>
            <button onclick="del(${d.row})">X</button>
          </td>
        </tr>`;
      });
    });
}

/* ================= POST ================= */
function post(data){
  return fetch(SHEET_API,{
    method:"POST",
    body:JSON.stringify(data)
  });
}

/* ================= ADD ================= */
function add(){
  if(!link.value) return alert("Ch∆∞a upload ·∫£nh");

  post({
    action:"add",
    link: link.value,
    name: name1.value,
    note: note.value
  }).then(()=>{
    name1.value="";
    note.value="";
    preview.style.display="none";
    imageInput.value="";
    link.value="";
    load();
  });
}

/* ================= SAVE ================= */
function save(e,row,col,el){
  if(e.key==="Enter"){
    e.preventDefault();
    post({
      action:"update",
      row:row,
      col:col,
      value:el.textContent.trim()
    });
    el.blur();
  }
}

/* ================= DELETE ================= */
function del(row){
  if(confirm("X√≥a d√≤ng n√†y?")){
    post({action:"delete",row:row}).then(load);
  }
}

/* ================= IMGBB UPLOAD ================= */
function uploadImage(){
  const file = imageInput.files[0];
  if(!file) return alert("Ch·ªçn ·∫£nh tr∆∞·ªõc");

  status.textContent="ƒêang upload...";

  const reader = new FileReader();
  reader.onload=()=>{
    const base64 = reader.result.split(",")[1];
    const fd = new FormData();
    fd.append("key", IMGBB_KEY);
    fd.append("image", base64);

    fetch("https://api.imgbb.com/1/upload",{
      method:"POST",
      body:fd
    })
    .then(r=>r.json())
    .then(res=>{
      if(res.success){
        link.value = res.data.url;
        preview.src = res.data.url;
        preview.style.display="block";
        status.textContent="Upload xong ‚úî";
      }else{
        status.textContent="Upload l·ªói";
      }
    });
  };
  reader.readAsDataURL(file);
}

load();
</script>

</body>
</html>
